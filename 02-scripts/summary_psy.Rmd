---
output:
  word_document: default
  html_document: default
bibliography:
- references.bib
- packages.bib
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

# The case study of *Pinus sylvestris*

## Spanish forest inventory and climate data

```{r data-summary}

library(tidyverse)
library(here)

tree23 <- read_csv(
  file = here("01-data", "ifn", "tree23.csv")
  )

# map(tree23 %>% select(Cla3, Subclase3),
#     ~levels(as.factor(.x)))

Psy23 <- tree23 %>% 
  group_by(IDPC3) %>% 
  mutate(
    AB2m2ha.tot.plot = sum(AB2m2ha, na.rm = T),
  ) %>% 
  group_by(IDPC3, sppcompa) %>% 
  mutate(
    AB2m2ha.plot = sum(AB2m2ha, na.rm = T), 
    AB2m2ha.rel.plot = AB2m2ha.plot * 100 / AB2m2ha.tot.plot
  ) %>% 
  filter(
    sppcompa == "021" & AB2m2ha.rel.plot >= 50
  )

planted <- read_tsv(
  here("01-data", "ifn", "Plotcode_RP.txt"),
  col_types = cols(.default = "c",
                   PLOTCODE = col_integer())
)

dat <- planted %>%
  dplyr::select(PLOTCODE, Psy) %>%
  mutate(Psy = if_else(is.na(Psy), "A", Psy))

Psy23_planted <- Psy23 %>%
  left_join(dat, by = c("Plotcode3" = "PLOTCODE"))

```

We selected all trees in permanent stands in the third Spanish forest
inventory census in which *Pinus sylvestris* had $\geq$ 50% of basal
area (`r nrow(Psy23)` *Pinus sylvestris* trees in
`r length(unique(Psy23$IDPC3))` stands, representing
`r round(nrow(Psy23) / nrow(tree23), 4) * 100`% of all trees). We
obtained the natural or planted character of each stand using the
Spanish Regions of Provenance for Forest Species [hereafter SRP, see
@alía2005]. This database determines the origin of the species (i.e.
natural or planted during the 20th century) based on historical
information [@ceballos1966] and other available information [@alía2009].
Thus, joining the selected *Pinus sylvestris* stands with the SRP
database we determined the natural or planted origin of the stands
[@ruiz-benito2012] (`r sum(Psy23_planted$Psy == "A")` natural
individuals located in
`r nrow(Psy23_planted |> distinct(IDPC3, .keep_all = T) |> filter(Psy == "A"))`
stands and `r sum(Psy23_planted$Psy == "P")` planted individuals located
in
`r nrow(Psy23_planted |> distinct(IDPC3, .keep_all = T) |> filter(Psy == "P"))`
stands).

We obtained forest structure variables using information from the second
and third Spanish forest inventory censuses because we wanted to have
the broadest possible structural representation of the analysed stands.
We calculated stand density (No. trees ha^-1^), stand basal area (m^2^
ha^-1^), mean d.b.h. (mm), mean height (m), coefficient of variation of
d.b.h. (adimensional), coefficient of variation of height
(adimensional), the ratio height:d.b.h (adimensional), species richness
(No. of species), recruitment (No. trees ha^-1^) and tree vigour
[categorical variable ranging from one, meaning healthy tree, to six,
meaning dead standing but non-rotten tree, calculated as the mean value
from the tree level quality index see @moreno-fernández2019]
<!--#  meaning (1) healthy, vigorous and dominant tree, (2) healthy and non-dominated tree with some formation defects; (3) dominated tree with poor health;(4) diseased, weak and old tree with many formation defects; 5) severely diseased tree; and (6) dead standing but non-rotten tree. -->.
Using all forest structure variables we made clusters considering all
planted and natural stands. Then, we obtained a variable that related
the natural or planted origin of the stand and the cluster to which that
stand belonged (hereafter management legacy, see Fig. S1 & S2).

Drought conditions were characterised using 12-month SPEI for the period
between the inventory censuses (adimensional) with a 0.5 degrees spatial
resolution from SPEIbase v2.5 [@vicente-serrano2010] (Fig. S5a). Water
availability index was calculated as the difference between annual
precipitation and potential evapotranspiration with respect to potential
evapotranspiration (i.e. (annual precipitation -- PET) / PET, %) for the
period 1970-2000 with a 1 km2 spatial resolution using data from
WorldClim 2 [@fick2017] and Global Aridity Index and Potential
Evapotranspiration (ET0) Climate Database v2 [@trabucco2019] (Fig. S5b).

## Analyses

We fitted hurdle-gamma models using the `glmmTMB` package [@R-glmmTMB].
As response variable we used tree mortality in each stand relative to
the initial basal area of the stand and considering the time elapsed
between consecutive censuses. On stands where there was no evidence of
cuts between consecutive censuses, mortality of absent and present trees
was used and on stands where there was evidence of cuts between censuses
only mortality of present trees was used. As conditional effects we
included management legacy, water availability index, SPEI and their
interactions with a ziGamma error distribution using a log link. We
included a zero-inflation model with the same fixed variables as for the
conditional model. The predictor variables were not strongly collinear
and model residual were diagnosed using `DHARMa` package [@R-DHARMa]
(Fig. S6 & S7).

We used predictive comparisons by applying a reduction of 18.435 of
water availability index and 0.069 of SPEI to all the current stand
conditions. Units for reducing the water availability index and SPEI
were selected as the difference between the median and the first
quantile of each variable when analysing all stands together. We also
compared the observed mortality with the predicted mortality of the
model for each management legacy (Fig. IA in Box 1).

Finally, we analysed transitions in structural typologies between the
second and the third Spanish Forest Inventory censuses (Table S1) and we
found that transitions mainly occurred from C1 to C2. Thus, we made
predictions setting all natural and planted stands as C2 while reducing
water availability index and SPEI by 18.435 and 0.069, respectively
(Fig. IB) and compared these predictions to the observed mortality.

All analyses were performed using R Statistical Software... and in
addition to the above-mentioned packages we also used `tidyverse`
[@R-tidyverse], `here` [@R-here], `patchwork` [@R-patchwork], `sf`
[@R-sf], `viridis` [@R-viridis], `corrr` [@R-corrr], `bbmle` [@R-bbmle],
`MASS` [@R-MASS], `performance` [@R-performance], `ggdist` [@R-ggdist],
`RColorBrewer` [@R-RColorBrewer], `testthat` [@R-testthat], `factoextra`
[@R-factoextra], `RColorBrewer` [@R-RColorBrewer], `ggh4x` [@R-ggh4x],
`janitor` [@R-janitor], `gt` [@R-gt]

```{r}
# https://ropensci.org/blog/2021/11/16/how-to-cite-r-and-r-packages/

print(citation(), style = "text")

knitr::write_bib(c(
  "glmmTMB", "bbmle", "DHARMa",
  "tidyverse",
  "here",
  "patchwork",
  "sf",
  "viridis",
  "corrr",
  "bbmle",
  "MASS",
  "performance",
  "ggdist",
  "RColorBrewer",
  "testthat",
  "factoextra",
  "RColorBrewer",
  "ggh4x",
  "janitor",
  "gt"
  ), file = "packages.bib")
```

## References

::: {#refs}
:::

------------------------------------------------------------------------

<details>

<summary>

Session Info

</summary>

```{r session-info}
Sys.time()
git2r::repository()
sessionInfo()
```

</details>
